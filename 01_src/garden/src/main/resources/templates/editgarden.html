<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit garden</title>

    <link rel="stylesheet" th:href="@{/styles/style.css}">
    <link rel="stylesheet" th:href="@{/styles/mobile.css}">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body class="home">
<div class="edit-page-wrapper" style="display:flex; flex-direction:column; gap:32px; width:100%;">

<div class="form-container">

    <a class="close-form-btn" th:href="@{/home}">
        <i class='bx bx-x'></i>
    </a>

    <h1>Upravit zahradu</h1>

    <form th:action="@{/garden/edit/{id}(id=${gardenDTO.id})}" th:object="${gardenDTO}" method="post" enctype="multipart/form-data">
        <div class="form-content">

            <div class="image-upload-card">
                <label for="garden-image" class="upload-area" style="cursor: pointer;">
                    <input type="file" id="garden-image" name="file" accept="image/*" style="display: none;" />

                    <div class="preview-container">
                        <img class="image-preview"
                             th:if="${gardenDTO.previewImageId != null}"
                             th:src="@{'/api/images/' + ${gardenDTO.previewImageId}}"
                             alt="Preview"/>
                        <div class="upload-placeholder"
                             th:if="${gardenDTO.previewImageId == null}">
                            <i class='bx bx-image-add'></i>
                            <p>Přidat fotografii zahrady</p>
                        </div>
                    </div>
                </label>
            </div>

            <div class="form-fields">
                <div class="input-box">
                    <input type="text" placeholder="Název zahrady" th:field="*{name}" required />
                    <div th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="error"></div>
                </div>

                <div class="input-box">
                    <input type="number" placeholder="Plocha (m2)" th:field="*{areaGarden}" required min="1" step="0.01" />
                    <div th:if="${#fields.hasErrors('areaGarden')}" th:errors="*{areaGarden}" class="error"></div>
                </div>

                <div class="input-box">
                    <input type="text" placeholder="Město" th:field="*{address.city}" required />
                    <div th:if="${#fields.hasErrors('address.city')}" th:errors="*{address.city}" class="error"></div>
                </div>

                <div class="address-row">
                    <div class="input-box">
                        <input type="text" placeholder="Ulice" th:field="*{address.street}" required />
                        <div th:if="${#fields.hasErrors('address.street')}" th:errors="*{address.street}" class="error"></div>
                    </div>
                    <div class="input-box">
                        <input type="text" placeholder="Číslo domu" th:field="*{address.houseNumber}" required />
                        <div th:if="${#fields.hasErrors('address.houseNumber')}" th:errors="*{address.houseNumber}" class="error"></div>
                    </div>
                    <div class="input-box">
                        <input type="text" placeholder="PSČ" th:field="*{address.zipCode}" required />
                        <div th:if="${#fields.hasErrors('address.zipCode')}" th:errors="*{address.zipCode}" class="error"></div>
                    </div>
                </div>

                <div th:if="${error}" class="error" th:text="${error}"></div>

                <button type="submit" class="btn">Uložit změny</button>
            </div>
        </div>
    </form>

    <form class="edit" th:action="@{|/garden/delete/${gardenDTO.id}|}" method="post">
        <button type="submit" class="delete">Smazat zahradu</button>
    </form>

</div>

<script>
    const imageInput = document.getElementById('garden-image');
    const imagePreview = document.querySelector('.image-preview');
    const placeholder = document.querySelector('.upload-placeholder');

    document.addEventListener('DOMContentLoaded', () => {
        if (imagePreview.src && imagePreview.src !== window.location.href) {
            imagePreview.style.display = 'block';
            const placeholder = document.querySelector('.upload-placeholder');
            if (placeholder) placeholder.style.display = 'none';
        }
    });

    imageInput.addEventListener('change', function () {
        const file = imageInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                if (placeholder) placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    });
</script>

<!-- SEKCE POZADAVKU -->
<div class="news request-section" style="padding: 32px 90px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
    <h2>Požadavky</h2>
    <div th:if="${#lists.isEmpty(requests)}">
        <p>Pro tuto zahradu zatím nejsou žádné požadavky.</p>
    </div>

    <div th:if="${!#lists.isEmpty(requests)}">
        <ul class="request-list">
            <li th:each="req : ${requests}" class="request-item" th:attr="data-req-id=${req.id}">
                <div class="summary">
                    <div class="req-left">
                        Pozadavek od <strong><span th:text="${#temporals.format(req.createdAt, 'dd.MM.yyyy')}"></span></strong>
                    </div>
                    <div class="req-right">
                        status: <strong><span th:text="${#strings.toLowerCase(req.status)}"></span></strong>
                    </div>
                </div>

                <div class="details">
                    <p class="description" th:text="${req.description}"></p>

                    <div class="actions">
                        <form th:action="@{/request/delete/{id}(id=${req.id})}" method="post">
                            <input type="hidden" name="gardenId" th:value="${gardenId}">
                            <button type="submit" class="btn">Smazat požadavek</button>
                        </form>
                    </div>
                </div>

            </li>
        </ul>
    </div>

    <form th:action="@{/request/add/{gardenId}(gardenId=${gardenId})}"
          th:object="${requestDTO}" method="post" style="margin-bottom:16px;">

        <div class="input-box" style="height:auto;">
            <textarea th:field="*{description}"
                      placeholder="Popište požadavek..."
                      rows="3" required
                      style="width:100%; resize:vertical;"></textarea>
        </div>

        <button type="submit" class="btn">Vytvořit nový požadavek</button>
    </form>


<!--    <button type="submit" class="btn"-->
<!--            th:onclick="|window.location.href='@{/request/add/{gardenId}(gardenId=${gardenId})}'|">-->
<!--        Vytvořit nový požadavek-->
<!--    </button>-->

</div>
</div>

<script>
    (function () {
        const list = document.querySelector('.request-list');
        if (!list) return;

        list.addEventListener('click', function (e) {
            if (e.target.closest('form')) return;

            const item = e.target.closest('.request-item');
            if (!item) return;

            document.querySelectorAll('.request-item.open')
                .forEach(el => { if (el !== item) el.classList.remove('open'); });

            item.classList.toggle('open');
        });

        document.addEventListener('click', function (e) {
            if (!e.target.closest('.request-section')) {
                document.querySelectorAll('.request-item.open')
                    .forEach(el => el.classList.remove('open'));
            }
        });
    })();
</script>

</body>
</html>